# ğŸŒ Gateway Management API Documentation\n\nA comprehensive API system for managing LoRa gateways, nodes, and IoT sensors in the smart parking system. This system provides role-based access control with separate functionality for Super Admins and Admins.\n\n## ğŸ—ï¸ System Architecture\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚   Super Admin       â”‚    â”‚   Admin             â”‚    â”‚   ChirpStack        â”‚\nâ”‚   - Create Gateways â”‚    â”‚   - Link Gateways   â”‚    â”‚   - LoRa Network    â”‚\nâ”‚   - Manage All      â”‚    â”‚   - Manage Nodes    â”‚    â”‚   - Send Webhooks   â”‚\nâ”‚   - View Statistics â”‚    â”‚   - Assign to Lots  â”‚    â”‚   - Device Status   â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n            â”‚                          â”‚                          â”‚\n            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                                       â”‚\n                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n                        â”‚   Smart Parking     â”‚\n                        â”‚   Backend API       â”‚\n                        â”‚   - Authentication  â”‚\n                        â”‚   - Role-based AC   â”‚\n                        â”‚   - Database Mgmt   â”‚\n                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## ğŸ‘¥ User Roles & Permissions\n\n### Super Admin\n- âœ… Create new gateways in the system\n- âœ… View all gateways with full details\n- âœ… Update gateway information\n- âœ… Delete unused gateways\n- âœ… View system-wide statistics\n- âœ… Access all gateway and node data\n\n### Admin\n- âœ… View available (unlinked) gateways\n- âœ… Link gateways to their account\n- âœ… Unlink gateways from their account\n- âœ… Create and manage nodes under linked gateways\n- âœ… Assign gateways to their parking lots\n- âœ… View statistics for their linked gateways\n- âŒ Cannot access other admins' gateways\n- âŒ Cannot create or delete gateways\n\n## ğŸ”§ Setup Instructions\n\n### Prerequisites\n- Node.js 18+\n- PostgreSQL 12+\n- TypeScript\n- Running smart parking backend\n\n### 1. Database Setup\nThe gateway tables are automatically created via TypeORM migrations:\n- `gateway` - Stores gateway information\n- `node` - Stores sensor node information\n- Updated `user` table with gateway relationships\n\n### 2. Environment Variables\nEnsure your `.env` file includes:\n```env\n# Database\nDB_HOST=localhost\nDB_PORT=5432\nDB_USERNAME=postgres\nDB_PASSWORD=your_password\nDB_NAME=smart_parking\n\n# JWT\nJWT_SECRET=your_super_secret_jwt_key\n\n# Server\nPORT=3000\nNODE_ENV=development\n```\n\n### 3. Start the Server\n```bash\nnpm run dev\n```\n\n## ğŸ“‹ API Endpoints Overview\n\n### Super Admin Endpoints\n| Method | Endpoint | Description |\n|--------|----------|-------------|\n| POST | `/api/gateways` | Create new gateway |\n| GET | `/api/gateways` | Get all gateways |\n| GET | `/api/gateways/{id}` | Get gateway by ID |\n| PUT | `/api/gateways/{id}` | Update gateway |\n| DELETE | `/api/gateways/{id}` | Delete gateway |\n\n### Admin Endpoints\n| Method | Endpoint | Description |\n|--------|----------|-------------|\n| GET | `/api/gateways/available` | Get available gateways |\n| POST | `/api/gateways/link` | Link gateway to account |\n| GET | `/api/gateways/my-gateways` | Get linked gateways |\n| POST | `/api/gateways/{id}/unlink` | Unlink gateway |\n| POST | `/api/gateways/{id}/assign-parking-lot` | Assign to parking lot |\n| POST | `/api/gateways/nodes` | Create node |\n| GET | `/api/gateways/{id}/nodes` | Get gateway nodes |\n| GET | `/api/gateways/statistics` | Get statistics |\n\n### Webhook Endpoints (Public)\n| Method | Endpoint | Description |\n|--------|----------|-------------|\n| POST | `/api/gateways/webhook/gateway-status` | Update gateway status |\n| POST | `/api/gateways/webhook/node-status` | Update node status |\n\n## ğŸ§ª Testing the Complete Flow\n\n### Automated Testing\nRun the comprehensive test suite:\n```bash\n# Basic testing\nnode test-gateway-apis.js\n\n# Verbose output\nVERBOSE=true node test-gateway-apis.js\n```\n\n### Manual Testing Flow\n\n#### Step 1: Create Super Admin\n```bash\ncurl -X POST http://localhost:3000/api/auth/signup \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"email\": \"superadmin@example.com\",\n    \"password\": \"SuperAdmin123!\",\n    \"firstName\": \"Super\",\n    \"lastName\": \"Admin\",\n    \"role\": \"super_admin\"\n  }'\n```\n\n#### Step 2: Login Super Admin\n```bash\ncurl -X POST http://localhost:3000/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"email\": \"superadmin@example.com\",\n    \"password\": \"SuperAdmin123!\"\n  }'\n```\n\n#### Step 3: Create Gateway (Super Admin)\n```bash\ncurl -X POST http://localhost:3000/api/gateways \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer YOUR_SUPER_ADMIN_TOKEN\" \\\n  -d '{\n    \"chirpstackGatewayId\": \"gw_001\",\n    \"name\": \"Main Building Gateway\",\n    \"description\": \"Primary gateway for main building\",\n    \"location\": \"Building A, Floor 1\",\n    \"latitude\": 40.7128,\n    \"longitude\": -74.0060,\n    \"metadata\": {\n      \"model\": \"RAK7249\",\n      \"version\": \"1.0.3\"\n    }\n  }'\n```\n\n#### Step 4: Create Admin User\n```bash\ncurl -X POST http://localhost:3000/api/auth/signup \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"email\": \"admin@example.com\",\n    \"password\": \"Admin123!\",\n    \"firstName\": \"Admin\",\n    \"lastName\": \"User\",\n    \"role\": \"admin\"\n  }'\n```\n\n#### Step 5: Login Admin and Link Gateway\n```bash\n# Login\ncurl -X POST http://localhost:3000/api/auth/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"email\": \"admin@example.com\",\n    \"password\": \"Admin123!\"\n  }'\n\n# Get available gateways\ncurl -X GET http://localhost:3000/api/gateways/available \\\n  -H \"Authorization: Bearer YOUR_ADMIN_TOKEN\"\n\n# Link gateway\ncurl -X POST http://localhost:3000/api/gateways/link \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer YOUR_ADMIN_TOKEN\" \\\n  -d '{\n    \"gatewayId\": 1\n  }'\n```\n\n#### Step 6: Create Nodes under Gateway\n```bash\ncurl -X POST http://localhost:3000/api/gateways/nodes \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer YOUR_ADMIN_TOKEN\" \\\n  -d '{\n    \"gatewayId\": 1,\n    \"chirpstackDeviceId\": \"sensor_001\",\n    \"name\": \"Parking Slot A1 Sensor\",\n    \"description\": \"Ultrasonic sensor for slot A1\",\n    \"latitude\": 40.7129,\n    \"longitude\": -74.0061,\n    \"metadata\": {\n      \"sensorType\": \"ultrasonic\",\n      \"range\": \"4m\"\n    }\n  }'\n```\n\n#### Step 7: View Gateway Nodes\n```bash\ncurl -X GET http://localhost:3000/api/gateways/1/nodes \\\n  -H \"Authorization: Bearer YOUR_ADMIN_TOKEN\"\n```\n\n#### Step 8: Get Statistics\n```bash\ncurl -X GET http://localhost:3000/api/gateways/statistics \\\n  -H \"Authorization: Bearer YOUR_ADMIN_TOKEN\"\n```\n\n#### Step 9: Test Webhooks (ChirpStack Integration)\n```bash\n# Update node status\ncurl -X POST http://localhost:3000/api/gateways/webhook/node-status \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"deviceId\": \"sensor_001\",\n    \"metadata\": {\n      \"batteryLevel\": 85,\n      \"rssi\": -72,\n      \"snr\": 8.5\n    }\n  }'\n\n# Update gateway status\ncurl -X POST http://localhost:3000/api/gateways/webhook/gateway-status \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"gatewayId\": \"gw_001\",\n    \"metadata\": {\n      \"temperature\": 42.5,\n      \"uptime\": 86400\n    }\n  }'\n```\n\n## ğŸ“Š Data Models\n\n### Gateway Model\n```typescript\ninterface Gateway {\n  id: number;\n  chirpstackGatewayId: string;    // Unique ChirpStack ID\n  name: string;\n  description?: string;\n  location?: string;\n  latitude?: number;\n  longitude?: number;\n  isActive: boolean;\n  isLinked: boolean;\n  lastSeen?: Date;\n  linkedAt?: Date;\n  linkedAdmin?: User;              // Admin who linked this gateway\n  createdBy?: User;               // Super admin who created it\n  parkingLot?: ParkingLot;        // Assigned parking lot\n  nodes: Node[];\n  metadata: Record<string, any>;\n  createdAt: Date;\n  updatedAt: Date;\n}\n```\n\n### Node Model\n```typescript\ninterface Node {\n  id: number;\n  chirpstackDeviceId: string;     // Unique ChirpStack device ID\n  name: string;\n  description?: string;\n  latitude?: number;\n  longitude?: number;\n  isActive: boolean;\n  isAssigned: boolean;            // Whether assigned to parking slot\n  lastSeen?: Date;\n  gateway: Gateway;               // Parent gateway\n  admin: User;                    // Owner admin\n  parkingSlot?: ParkingSlot;      // Assigned parking slot\n  metadata: Record<string, any>;  // Sensor data, battery, etc.\n  createdAt: Date;\n  updatedAt: Date;\n}\n```\n\n## ğŸ” Authentication & Authorization\n\n### JWT Token Requirements\nAll protected endpoints require a valid JWT token:\n```\nAuthorization: Bearer YOUR_JWT_TOKEN\n```\n\n### Role-Based Access Control\n- **Super Admin**: Full access to all gateway operations\n- **Admin**: Limited to linked gateways and node management\n- **User**: No gateway access (parking operations only)\n\n## ğŸš¨ Error Handling\n\n### Common Error Responses\n\n#### 400 Bad Request\n```json\n{\n  \"success\": false,\n  \"message\": \"Validation failed\",\n  \"errors\": [\n    \"ChirpStack Gateway ID is required\",\n    \"Invalid latitude value\"\n  ]\n}\n```\n\n#### 401 Unauthorized\n```json\n{\n  \"success\": false,\n  \"message\": \"Authentication required\"\n}\n```\n\n#### 403 Forbidden\n```json\n{\n  \"success\": false,\n  \"message\": \"Access denied. Super Admin privileges required.\"\n}\n```\n\n#### 404 Not Found\n```json\n{\n  \"success\": false,\n  \"message\": \"Gateway not found\"\n}\n```\n\n## ğŸ“ˆ Monitoring & Status\n\n### Gateway Status\n- **Online**: Last seen within 5 minutes\n- **Offline**: Last seen > 5 minutes ago\n- **Inactive**: Manually deactivated\n\n### Node Status\n- **Online**: Last seen within 5 minutes\n- **Offline**: Last seen > 5 minutes ago\n- **Inactive**: Manually deactivated\n\n### Statistics Available\n- Total gateways (system-wide or admin-specific)\n- Active gateways\n- Linked gateways\n- Total nodes\n- Active nodes\n- Online nodes (real-time)\n\n## ğŸ”— ChirpStack Integration\n\n### Webhook Configuration\nConfigure ChirpStack to send webhooks to:\n- Gateway status: `http://your-domain/api/gateways/webhook/gateway-status`\n- Node status: `http://your-domain/api/gateways/webhook/node-status`\n\n### Expected Webhook Payloads\n\n#### Gateway Status Webhook\n```json\n{\n  \"gatewayId\": \"gw_001\",\n  \"metadata\": {\n    \"temperature\": 42.5,\n    \"uptime\": 86400,\n    \"lastSeen\": \"2025-01-15T10:30:00Z\"\n  }\n}\n```\n\n#### Node Status Webhook\n```json\n{\n  \"deviceId\": \"sensor_001\",\n  \"metadata\": {\n    \"batteryLevel\": 85,\n    \"rssi\": -72,\n    \"snr\": 8.5,\n    \"lastSeen\": \"2025-01-15T10:30:00Z\"\n  }\n}\n```\n\n## ğŸƒâ€â™‚ï¸ Quick Start Examples\n\n### 1. Super Admin - Create and Manage Gateway\n```javascript\nconst axios = require('axios');\nconst BASE_URL = 'http://localhost:3000/api';\n\n// 1. Login as Super Admin\nconst loginResponse = await axios.post(`${BASE_URL}/auth/login`, {\n  email: 'superadmin@example.com',\n  password: 'SuperAdmin123!'\n});\nconst superAdminToken = loginResponse.data.data.token;\n\n// 2. Create Gateway\nconst gateway = await axios.post(`${BASE_URL}/gateways`, {\n  chirpstackGatewayId: 'gw_001',\n  name: 'Main Gateway',\n  description: 'Primary building gateway',\n  location: 'Building A',\n  latitude: 40.7128,\n  longitude: -74.0060\n}, {\n  headers: { Authorization: `Bearer ${superAdminToken}` }\n});\n\nconsole.log('Gateway created:', gateway.data.data);\n```\n\n### 2. Admin - Link Gateway and Create Nodes\n```javascript\n// 1. Login as Admin\nconst adminLogin = await axios.post(`${BASE_URL}/auth/login`, {\n  email: 'admin@example.com',\n  password: 'Admin123!'\n});\nconst adminToken = adminLogin.data.data.token;\n\n// 2. Get Available Gateways\nconst available = await axios.get(`${BASE_URL}/gateways/available`, {\n  headers: { Authorization: `Bearer ${adminToken}` }\n});\nconsole.log('Available gateways:', available.data.data.length);\n\n// 3. Link Gateway\nconst linkResult = await axios.post(`${BASE_URL}/gateways/link`, {\n  gatewayId: 1\n}, {\n  headers: { Authorization: `Bearer ${adminToken}` }\n});\nconsole.log('Gateway linked successfully');\n\n// 4. Create Node\nconst node = await axios.post(`${BASE_URL}/gateways/nodes`, {\n  gatewayId: 1,\n  chirpstackDeviceId: 'sensor_001',\n  name: 'Parking Sensor A1',\n  description: 'Ultrasonic sensor for slot A1'\n}, {\n  headers: { Authorization: `Bearer ${adminToken}` }\n});\nconsole.log('Node created:', node.data.data);\n```\n\n## ğŸ“š API Documentation\n\nComplete interactive API documentation is available at:\n- **Swagger UI**: `http://localhost:3000/api-docs`\n- Browse all endpoints with examples\n- Test APIs directly from the browser\n- View request/response schemas\n\n## ğŸ§ª Test Results Expected\n\nWhen running `node test-gateway-apis.js`, you should see:\n\n```\nğŸš€ Starting Gateway Management API Tests...\n\nğŸ”§ Setting up test users...\nâœ… Super admin authenticated successfully\nâœ… Admin authenticated successfully\n\nâœ… PASS Create Gateway: Gateway created successfully\nâœ… PASS Get All Gateways: Retrieved 1 gateways\nâœ… PASS Get Gateway by ID: Gateway retrieved successfully\nâœ… PASS Update Gateway: Gateway updated successfully\nâœ… PASS Get Available Gateways: Found 1 available gateways\nâœ… PASS Link Gateway: Gateway linked to admin successfully\nâœ… PASS Get Linked Gateways: Found 1 linked gateways\nâœ… PASS Create Node: Node created successfully\nâœ… PASS Get Gateway Nodes: Found 1 nodes for gateway\nâœ… PASS Get Statistics: Stats - Gateways: 1, Nodes: 1, Online: 0\nâœ… PASS Node Status Webhook: Node status updated via webhook\nâœ… PASS Gateway Status Webhook: Gateway status updated via webhook\nâœ… PASS Admin Access Control: Admin correctly denied access to super admin endpoint\nâœ… PASS Unauthenticated Access Control: Unauthenticated user correctly denied access\n\nğŸ“Š Gateway API Test Results:\n   Passed: 14/14\n   Success Rate: 100%\n\nğŸ‰ All gateway API tests passed! Your gateway management system is working perfectly.\n```\n\n## ğŸ†˜ Troubleshooting\n\n### Common Issues\n\n1. **Authentication Errors**\n   - Ensure JWT tokens are valid\n   - Check user roles are correctly set\n   - Verify token expiry\n\n2. **Database Errors**\n   - Check PostgreSQL connection\n   - Ensure TypeORM synchronization is enabled\n   - Verify database permissions\n\n3. **Permission Errors**\n   - Super admin role required for gateway CRUD operations\n   - Admin role required for linking and node management\n   - Check role-based middleware\n\n4. **Webhook Issues**\n   - Verify webhook endpoints are accessible\n   - Check ChirpStack configuration\n   - Ensure correct payload format\n\n### Debug Mode\n```bash\n# Enable detailed logging\nDEBUG=* node test-gateway-apis.js\n\n# Verbose test output\nVERBOSE=true node test-gateway-apis.js\n```\n\n## ğŸ¯ Next Steps\n\n1. **Integrate with ChirpStack**\n   - Configure webhook endpoints\n   - Set up device provisioning\n   - Test real sensor data\n\n2. **Add Real-time Features**\n   - WebSocket connections\n   - Live status updates\n   - Real-time dashboards\n\n3. **Enhanced Monitoring**\n   - Gateway health checks\n   - Node battery monitoring\n   - Alerting system\n\n4. **Extend Functionality**\n   - Bulk gateway operations\n   - Gateway groups/zones\n   - Advanced analytics\n\n---\n\n**Built with â¤ï¸ for smart city IoT solutions**\n\nFor support or questions, check the test files and API documentation at `/api-docs`."